# =============================================================================
# ìˆ˜ë™ ì„¤ì • ë¶€ë¶„
# =============================================================================
working_directory = r"D:\ì±„ê¶Œ\ì‘ì—…ì¤‘"
source_file = "real_data1.xlsx"
output_prefix = "decrypted_"

# =============================================================================
# ìë™ ì‹¤í–‰ ë¶€ë¶„ (ìˆ˜ì • ë¶ˆí•„ìš”)
# =============================================================================
import os
import win32com.client
from pathlib import Path
from datetime import datetime
import time
import pythoncom
import psutil
from openpyxl import Workbook

def clean_cell_value(value):
    """ì…€ ê°’ì—ì„œ íƒ€ì„ì¡´ ì •ë³´ ì œê±°"""
    if isinstance(value, datetime):
        return value.replace(tzinfo=None)
    return value

def is_external_function(formula):
    """ì™¸ë¶€ í•¨ìˆ˜ì¸ì§€ í™•ì¸"""
    if not formula or not isinstance(formula, str):
        return False
    
    formula_upper = formula.upper()
    external_functions = [
        'INFOMAX', 'RTD', 'WEBSERVICE', 'EXTERNAL', 
        'BLOOMBERG', 'REUTERS', 'FACTSET', 'REFINITIV'
    ]
    
    return any(func in formula_upper for func in external_functions)

def kill_excel_processes():
    """ëª¨ë“  Excel í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ"""
    print("Excel í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ ì¤‘...")
    
    killed_count = 0
    for proc in psutil.process_iter(['pid', 'name']):
        try:
            if proc.info['name'].upper() in ['EXCEL.EXE', 'WINWORD.EXE', 'POWERPNT.EXE']:
                proc.kill()
                killed_count += 1
                print(f"  {proc.info['name']} (PID: {proc.info['pid']}) ì¢…ë£Œë¨")
        except (psutil.NoSuchProcess, psutil.AccessDenied):
            pass
    
    if killed_count > 0:
        print(f"ì´ {killed_count}ê°œ Office í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ")
        time.sleep(2)
    else:
        print("ì‹¤í–‰ ì¤‘ì¸ Office í”„ë¡œì„¸ìŠ¤ ì—†ìŒ")

def excel_drm_bypass_fixed_len_error(source_path, output_path):
    """__len__ ì˜¤ë¥˜ í•´ê²° Excel DRM ìš°íšŒ"""
    print("__len__ ì˜¤ë¥˜ í•´ê²° Excel ì²˜ë¦¬ ì‹œì‘...")
    
    # 1ë‹¨ê³„: Excel í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
    kill_excel_processes()
    
    # 2ë‹¨ê³„: íŒŒì¼ ì ‘ê·¼ ê¶Œí•œ í™•ì¸
    try:
        with open(source_path, 'rb') as test_file:
            test_file.read(100)
        print("íŒŒì¼ ì ‘ê·¼ ê¶Œí•œ í™•ì¸ë¨")
    except Exception as access_error:
        print(f"íŒŒì¼ ì ‘ê·¼ ì˜¤ë¥˜: {access_error}")
        return False
    
    excel = None
    workbook = None
    
    try:
        # 3ë‹¨ê³„: Excel ì´ˆê¸°í™”
        print("Excel COM ì´ˆê¸°í™”...")
        pythoncom.CoInitializeEx(pythoncom.COINIT_APARTMENTTHREADED)
        
        excel = win32com.client.DispatchEx("Excel.Application")
        excel.Visible = False
        excel.DisplayAlerts = False
        excel.ScreenUpdating = False
        excel.EnableEvents = False
        excel.AskToUpdateLinks = False
        
        print("Excel ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒì„± ì„±ê³µ")
        
        # 4ë‹¨ê³„: ì•ˆì „í•œ íŒŒì¼ ì—´ê¸° (COM ê°ì²´ ì•ˆì „ ì²´í¬)
        print("ì•ˆì „í•œ ë°©ë²•ìœ¼ë¡œ íŒŒì¼ ì—´ê¸°...")
        
        workbook_opened = False
        
        # ë°©ë²• 1: ì™¸ë¶€ ì—°ê²° ì°¨ë‹¨ + ëª¨ë“  ì˜µì…˜
        try:
            print("  ë°©ë²• 1: ì™„ì „ ì°¨ë‹¨ ë°©ì‹ ì‹œë„...")
            workbook = excel.Workbooks.Open(
                source_path,
                UpdateLinks=0,
                ReadOnly=True,
                IgnoreReadOnlyRecommended=True,
                CorruptLoad=2
            )
            workbook_opened = True
            print("  ë°©ë²• 1 ì„±ê³µ!")
        except Exception as open1_error:
            print(f"  ë°©ë²• 1 ì‹¤íŒ¨: {open1_error}")
        
        # ë°©ë²• 2: ê¸°ë³¸ + ì™¸ë¶€ ì—°ê²° ì°¨ë‹¨
        if not workbook_opened:
            try:
                print("  ë°©ë²• 2: ê¸°ë³¸ ì°¨ë‹¨ ë°©ì‹ ì‹œë„...")
                workbook = excel.Workbooks.Open(source_path, UpdateLinks=0, ReadOnly=True)
                workbook_opened = True
                print("  ë°©ë²• 2 ì„±ê³µ!")
            except Exception as open2_error:
                print(f"  ë°©ë²• 2 ì‹¤íŒ¨: {open2_error}")
        
        # ë°©ë²• 3: ìµœì†Œ ì˜µì…˜
        if not workbook_opened:
            try:
                print("  ë°©ë²• 3: ìµœì†Œ ì˜µì…˜ ë°©ì‹ ì‹œë„...")
                workbook = excel.Workbooks.Open(source_path, UpdateLinks=0)
                workbook_opened = True
                print("  ë°©ë²• 3 ì„±ê³µ!")
            except Exception as open3_error:
                print(f"  ë°©ë²• 3 ì‹¤íŒ¨: {open3_error}")
        
        # ë°©ë²• 4: ê¸°ë³¸ ì—´ê¸°
        if not workbook_opened:
            try:
                print("  ë°©ë²• 4: ê¸°ë³¸ ì—´ê¸° ì‹œë„...")
                workbook = excel.Workbooks.Open(source_path)
                workbook_opened = True
                print("  ë°©ë²• 4 ì„±ê³µ!")
            except Exception as open4_error:
                print(f"  ë°©ë²• 4 ì‹¤íŒ¨: {open4_error}")
        
        # íŒŒì¼ ì—´ê¸° ê²€ì¦
        if not workbook_opened:
            raise Exception("ëª¨ë“  íŒŒì¼ ì—´ê¸° ë°©ë²• ì‹¤íŒ¨")
        
        # workbook ê°ì²´ ìœ íš¨ì„± ê²€ì¦ (ì•ˆì „í•œ ë°©ë²•)
        try:
            worksheet_count = workbook.Worksheets.Count
            print(f"ì›Œí¬ë¶ ë¡œë“œ í™•ì¸: {worksheet_count}ê°œ ì›Œí¬ì‹œíŠ¸")
        except Exception as verify_error:
            print(f"ì›Œí¬ë¶ ê²€ì¦ ì‹¤íŒ¨: {verify_error}")
            raise Exception("ì›Œí¬ë¶ì´ ì œëŒ€ë¡œ ë¡œë“œë˜ì§€ ì•ŠìŒ")
        
        # 5ë‹¨ê³„: ê³„ì‚° ëª¨ë“œ ìˆ˜ë™ ì„¤ì •
        print("ê³„ì‚° ëª¨ë“œ ìˆ˜ë™ ì„¤ì •...")
        try:
            excel.Calculation = -4135  # xlCalculationManual
            excel.CalculateBeforeSave = False
            print("ìˆ˜ë™ ê³„ì‚° ëª¨ë“œ ì„¤ì • ì™„ë£Œ")
        except Exception as calc_error:
            print(f"ê³„ì‚° ëª¨ë“œ ì„¤ì • ì˜¤ë¥˜: {calc_error}")
        
        # 6ë‹¨ê³„: ì›Œí¬ì‹œíŠ¸ ì„ íƒ
        print("ì›Œí¬ì‹œíŠ¸ ì„ íƒ...")
        try:
            worksheet = workbook.Worksheets(1)
            print(f"ì›Œí¬ì‹œíŠ¸ ì„ íƒ ì„±ê³µ: {worksheet.Name}")
        except Exception as ws_error:
            print(f"ì›Œí¬ì‹œíŠ¸ ì„ íƒ ì˜¤ë¥˜: {ws_error}")
            raise
        
        # 7ë‹¨ê³„: ì‚¬ìš©ëœ ë²”ìœ„ í™•ì¸
        print("ì‚¬ìš©ëœ ë²”ìœ„ í™•ì¸...")
        try:
            used_range = worksheet.UsedRange
            
            # used_range ê²€ì¦ (ì•ˆì „í•œ ë°©ë²•)
            try:
                rows = used_range.Rows.Count
                cols = used_range.Columns.Count
                print(f"ì‚¬ìš©ëœ ë²”ìœ„: {rows}í–‰ {cols}ì—´")
            except Exception as range_verify_error:
                print(f"ë²”ìœ„ í™•ì¸ ì‹¤íŒ¨: {range_verify_error}")
                # ëŒ€ì²´ ë°©ë²•
                last_cell = worksheet.Cells.SpecialCells(11)
                rows = last_cell.Row
                cols = last_cell.Column
                print(f"ëŒ€ì²´ ë°©ë²•ìœ¼ë¡œ ë²”ìœ„ í™•ì¸: {rows}í–‰ {cols}ì—´")
                
                # ë²”ìœ„ ì¬ì„¤ì •
                range_address = f"A1:{chr(64 + min(cols, 26))}{min(rows, 5000)}"
                used_range = worksheet.Range(range_address)
                
        except Exception as range_error:
            print(f"ë²”ìœ„ í™•ì¸ ì˜¤ë¥˜: {range_error}")
            raise
        
        # 8ë‹¨ê³„: ê³ ì† ë°ì´í„° ì¶”ì¶œ
        print("ê³ ì† ë°ì´í„° ì¶”ì¶œ ì‹œì‘...")
        start_extract = time.time()
        
        values_data = None
        formulas_data = None
        
        try:
            # ì „ì²´ ê°’ í•œ ë²ˆì— ì¶”ì¶œ
            print("  ì „ì²´ ê°’ ì¶”ì¶œ...")
            values_data = used_range.Value
            print(f"  ê°’ ì¶”ì¶œ ì™„ë£Œ ({time.time() - start_extract:.2f}ì´ˆ)")
            
            # ì „ì²´ ìˆ˜ì‹ í•œ ë²ˆì— ì¶”ì¶œ
            print("  ì „ì²´ ìˆ˜ì‹ ì¶”ì¶œ...")
            start_formula = time.time()
            try:
                formulas_data = used_range.Formula
                print(f"  ìˆ˜ì‹ ì¶”ì¶œ ì™„ë£Œ ({time.time() - start_formula:.2f}ì´ˆ)")
            except Exception as formula_error:
                print(f"  ìˆ˜ì‹ ì¶”ì¶œ ì‹¤íŒ¨: {formula_error}")
                print("  ìˆ˜ì‹ ì—†ì´ ì§„í–‰...")
                formulas_data = None
            
        except Exception as extract_error:
            print(f"ê³ ì† ì¶”ì¶œ ì‹¤íŒ¨: {extract_error}")
            print("ê°œë³„ ì…€ ì ‘ê·¼ìœ¼ë¡œ í´ë°±...")
            
            # í´ë°±: ê°œë³„ ì…€ ì ‘ê·¼
            values_data = []
            formulas_data = []
            
            for row in range(1, min(rows + 1, 3000)):
                value_row = []
                formula_row = []
                
                for col in range(1, min(cols + 1, 100)):
                    try:
                        cell = worksheet.Cells(row, col)
                        value_row.append(cell.Value)
                        if cell.HasFormula:
                            formula_row.append(cell.Formula)
                        else:
                            formula_row.append(None)
                    except:
                        value_row.append(None)
                        formula_row.append(None)
                
                values_data.append(tuple(value_row))
                formulas_data.append(tuple(formula_row))
                
                if row % 100 == 0:
                    print(f"    {row}í–‰ ì²˜ë¦¬...")
            
            values_data = tuple(values_data)
            formulas_data = tuple(formulas_data)
            print("ê°œë³„ ì…€ ì ‘ê·¼ ì™„ë£Œ")
        
        # 9ë‹¨ê³„: Excel ì¢…ë£Œ
        print("Excel ì¢…ë£Œ...")
        try:
            workbook.Close(SaveChanges=False)
            workbook = None
            excel.Quit()
            excel = None
            pythoncom.CoUninitialize()
            print("Excel ì •ìƒ ì¢…ë£Œ")
        except Exception as close_error:
            print(f"Excel ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜: {close_error}")
        
        # 10ë‹¨ê³„: ë©”ëª¨ë¦¬ì—ì„œ ê³ ì† ì²˜ë¦¬
        print("ë©”ëª¨ë¦¬ì—ì„œ ê³ ì† ì²˜ë¦¬...")
        start_process = time.time()
        
        # ë°ì´í„° ê²€ì¦ ë° ì •ê·œí™”
        if values_data is None:
            print("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤")
            return False
        
        # ë°ì´í„° íƒ€ì… ì •ê·œí™”
        if not isinstance(values_data, tuple):
            values_data = ((values_data,),)
        elif len(values_data) > 0 and not isinstance(values_data[0], tuple):
            values_data = tuple((item,) for item in values_data)
        
        if formulas_data:
            if not isinstance(formulas_data, tuple):
                formulas_data = ((formulas_data,),)
            elif len(formulas_data) > 0 and not isinstance(formulas_data[0], tuple):
                formulas_data = tuple((item,) for item in formulas_data)
        
        # í†µê³„
        external_functions_found = 0
        internal_functions_preserved = 0
        values_preserved = 0
        
        # ìƒˆ Excel íŒŒì¼ ìƒì„±
        print("ìƒˆ íŒŒì¼ ìƒì„±...")
        wb = Workbook()
        ws = wb.active
        
        for row_idx, value_row in enumerate(values_data):
            if not isinstance(value_row, tuple):
                value_row = (value_row,)
            
            # í•´ë‹¹ í–‰ì˜ ìˆ˜ì‹
            formula_row = None
            if formulas_data and row_idx < len(formulas_data):
                formula_row = formulas_data[row_idx]
                if not isinstance(formula_row, tuple):
                    formula_row = (formula_row,)
            
            for col_idx, cell_value in enumerate(value_row):
                excel_row = row_idx + 1
                excel_col = col_idx + 1
                
                try:
                    # ìˆ˜ì‹ í™•ì¸
                    cell_formula = None
                    if formula_row and col_idx < len(formula_row):
                        cell_formula = formula_row[col_idx]
                    
                    # ìˆ˜ì‹ ì²˜ë¦¬
                    has_formula = (cell_formula and 
                                 isinstance(cell_formula, str) and 
                                 cell_formula.startswith('='))
                    
                    if has_formula:
                        if is_external_function(cell_formula):
                            # ì™¸ë¶€ í•¨ìˆ˜ â†’ ê°’ ë³€í™˜
                            ws.cell(row=excel_row, column=excel_col, value=clean_cell_value(cell_value))
                            external_functions_found += 1
                        else:
                            # ì¼ë°˜ í•¨ìˆ˜ â†’ ìˆ˜ì‹ ë³´ì¡´
                            ws.cell(row=excel_row, column=excel_col, value=cell_formula)
                            internal_functions_preserved += 1
                    else:
                        # ì¼ë°˜ ê°’
                        ws.cell(row=excel_row, column=excel_col, value=clean_cell_value(cell_value))
                        if cell_value is not None and str(cell_value).strip():
                            values_preserved += 1
                
                except Exception:
                    ws.cell(row=excel_row, column=excel_col, value="")
        
        process_time = time.time() - start_process
        print(f"ë©”ëª¨ë¦¬ ì²˜ë¦¬ ì™„ë£Œ: {process_time:.2f}ì´ˆ")
        
        # 11ë‹¨ê³„: íŒŒì¼ ì €ì¥
        print("íŒŒì¼ ì €ì¥...")
        wb.save(output_path)
        wb.close()
        
        total_time = time.time() - start_extract
        print(f"ì´ ë°ì´í„° ì²˜ë¦¬ ì‹œê°„: {total_time:.2f}ì´ˆ")
        print("ì²˜ë¦¬ í†µê³„:")
        print(f"  - ì™¸ë¶€ í•¨ìˆ˜ â†’ ê°’ ë³€í™˜: {external_functions_found}ê°œ")
        print(f"  - ì¼ë°˜ í•¨ìˆ˜ ë³´ì¡´: {internal_functions_preserved}ê°œ")
        print(f"  - ì¼ë°˜ ê°’ ë³´ì¡´: {values_preserved}ê°œ")
        
        return True
        
    except Exception as main_error:
        print(f"ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {main_error}")
        return False
        
    finally:
        # ë¦¬ì†ŒìŠ¤ ì •ë¦¬
        try:
            if workbook is not None:
                workbook.Close(SaveChanges=False)
        except:
            pass
        
        try:
            if excel is not None:
                excel.Quit()
        except:
            pass
        
        try:
            pythoncom.CoUninitialize()
        except:
            pass

def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    source_path = os.path.join(working_directory, source_file)
    
    file_path = Path(source_file)
    output_filename = f"{output_prefix}{file_path.name}"
    output_path = os.path.join(working_directory, output_filename)
    
    print("=" * 60)
    print("Excel DRM ë³µí˜¸í™” íˆ´")
    print("=" * 60)
    print("COM ê°ì²´ ì•ˆì „ ì²˜ë¦¬ + ê³ ì† ë°ì´í„° ì²˜ë¦¬")
    print("=" * 60)
    
    if not os.path.exists(source_path):
        print(f"ì˜¤ë¥˜: íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: {source_path}")
        return
    
    file_size = os.path.getsize(source_path)
    print(f"ì›ë³¸ íŒŒì¼ í¬ê¸°: {file_size:,} bytes")
    
    start_time = time.time()
    
    if excel_drm_bypass_fixed_len_error(source_path, output_path):
        elapsed_time = time.time() - start_time
        print("-" * 50)
        print(f"âœ… Excel DRM ìš°íšŒ ì™„ë£Œ! (ì†Œìš”ì‹œê°„: {elapsed_time:.2f}ì´ˆ)")
        print(f"ğŸ“ ì €ì¥ ìœ„ì¹˜: {output_path}")
        
        if os.path.exists(output_path):
            output_size = os.path.getsize(output_path)
            print(f"ğŸ“Š ìƒì„±ëœ íŒŒì¼ í¬ê¸°: {output_size:,} bytes")
    else:
        elapsed_time = time.time() - start_time
        print("-" * 50)
        print(f"âŒ Excel DRM ìš°íšŒ ì‹¤íŒ¨ (ì†Œìš”ì‹œê°„: {elapsed_time:.2f}ì´ˆ)")

if __name__ == "__main__":
    main()
