# ì—‘ì…€ ë³µí˜¸í™” íˆ´ (ì—‘ì…€ ì™¸ ë¯¸ì™„ì„±)

# =============================================================================
# ìˆ˜ë™ ì„¤ì • ë¶€ë¶„
# =============================================================================
working_directory = r"D:\ì±„ê¶Œ\ì‘ì—…ì¤‘"
source_file = "real_data.xlsx"
output_prefix = "decrypted_"
# =============================================================================
# ìë™ ì‹¤í–‰ ë¶€ë¶„ (ìˆ˜ì • ë¶ˆí•„ìš”)
# =============================================================================
import os
import win32com.client
from pathlib import Path
from datetime import datetime
import time
import pythoncom
from openpyxl import Workbook
from openpyxl.styles import Font, Alignment, Border, Side

def clean_cell_value(value):
    """ì…€ ê°’ì—ì„œ íƒ€ì„ì¡´ ì •ë³´ ì œê±°"""
    if isinstance(value, datetime):
        return value.replace(tzinfo=None)
    return value

def excel_drm_bypass(source_path, output_path):
    """Excel DRM ìš°íšŒ (ê¸°ì¡´ ê²€ì¦ëœ ì½”ë“œ)"""
    print("Excel íŒŒì¼ ì²˜ë¦¬ ì¤‘...")
    
    pythoncom.CoInitialize()
    excel = win32com.client.DispatchEx("Excel.Application")
    excel.Visible = False
    excel.DisplayAlerts = False
    
    try:
        workbook = excel.Workbooks.Open(source_path)
        worksheet = workbook.Worksheets(1)
        used_range = worksheet.UsedRange
        
        if not used_range:
            print("ë¹ˆ ì›Œí¬ì‹œíŠ¸ì…ë‹ˆë‹¤.")
            return False
            
        rows = used_range.Rows.Count
        cols = used_range.Columns.Count
        print(f"ë°ì´í„° ë²”ìœ„: {rows}í–‰ {cols}ì—´")
        
        data_range = used_range.Value
        cleaned_data = []
        
        if isinstance(data_range, tuple):
            for row_data in data_range:
                if isinstance(row_data, tuple):
                    cleaned_row = [clean_cell_value(cell) for cell in row_data]
                else:
                    cleaned_row = [clean_cell_value(row_data)]
                cleaned_data.append(cleaned_row)
        else:
            cleaned_data = [[clean_cell_value(data_range)]]
        
        workbook.Close(False)
        excel.Quit()
        pythoncom.CoUninitialize()
        
        # openpyxlë¡œ ì €ì¥ (DRM ìš°íšŒ)
        wb = Workbook()
        ws = wb.active
        
        for row_idx, row_data in enumerate(cleaned_data, 1):
            for col_idx, cell_value in enumerate(row_data, 1):
                ws.cell(row=row_idx, column=col_idx, value=cell_value)
        
        wb.save(output_path)
        wb.close()
        
        print("Excel íŒŒì¼ ë³€í™˜ ì™„ë£Œ")
        return True
        
    except Exception as e:
        print(f"Excel ì²˜ë¦¬ ì˜¤ë¥˜: {e}")
        try:
            excel.Quit()
            pythoncom.CoUninitialize()
        except:
            pass
        return False

def pdf_drm_bypass(source_path, output_path):
    """PDF DRM ìš°íšŒ - Adobe Readerë¡œ ì½ê³  Pythonìœ¼ë¡œ ì €ì¥"""
    print("PDF íŒŒì¼ ì²˜ë¦¬ ì¤‘...")
    
    try:
        # PyMuPDF ì„¤ì¹˜ í™•ì¸
        try:
            import fitz
        except ImportError:
            print("PyMuPDFë¥¼ ì„¤ì¹˜í•´ì£¼ì„¸ìš”: pip install PyMuPDF")
            return False
        
        # Adobe Acrobat/Reader COM ê°ì²´ ì‹œë„
        try:
            pythoncom.CoInitialize()
            # Adobe Acrobatì´ ì„¤ì¹˜ëœ ê²½ìš°
            acrobat = win32com.client.DispatchEx("AcroExch.App")
            acrobat.Show()
            
            av_doc = win32com.client.DispatchEx("AcroExch.AVDoc")
            if av_doc.Open(source_path, ""):
                pd_doc = av_doc.GetPDDoc()
                
                # ì„ì‹œ íŒŒì¼ë¡œ ì €ì¥ (Adobeë¥¼ í†µí•´)
                temp_path = source_path.replace('.pdf', '_temp.pdf')
                pd_doc.Save(1, temp_path)  # PDSaveIncremental
                
                av_doc.Close(True)
                acrobat.Exit()
                acrobat = None
                pythoncom.CoUninitialize()
                
                # ì„ì‹œ íŒŒì¼ì„ PyMuPDFë¡œ ë‹¤ì‹œ ì²˜ë¦¬ (DRM ìš°íšŒ)
                doc = fitz.open(temp_path)
                new_doc = fitz.open()
                
                for page_num in range(len(doc)):
                    page = doc[page_num]
                    new_doc.insert_pdf(doc, from_page=page_num, to_page=page_num)
                
                new_doc.save(output_path)
                new_doc.close()
                doc.close()
                
                # ì„ì‹œ íŒŒì¼ ì‚­ì œ
                if os.path.exists(temp_path):
                    time.sleep(1)
                    os.remove(temp_path)
                
                print("PDF íŒŒì¼ ë³€í™˜ ì™„ë£Œ (Adobeë¥¼ í†µí•œ DRM ìš°íšŒ)")
                return True
            else:
                raise Exception("Adobeë¡œ íŒŒì¼ ì—´ê¸° ì‹¤íŒ¨")
                
        except Exception as adobe_error:
            print(f"Adobe ë°©ì‹ ì‹¤íŒ¨, ì§ì ‘ ë°©ì‹ ì‹œë„: {adobe_error}")
            
            # ì§ì ‘ PyMuPDFë¡œ ì‹œë„ (ì¼ë¶€ DRM PDFëŠ” ì§ì ‘ ì½ê¸° ê°€ëŠ¥)
            try:
                doc = fitz.open(source_path)
                new_doc = fitz.open()
                
                for page_num in range(len(doc)):
                    page = doc[page_num]
                    # í…ìŠ¤íŠ¸ì™€ ì´ë¯¸ì§€ ì¶”ì¶œ
                    text_dict = page.get_text("dict")
                    
                    # ìƒˆ í˜ì´ì§€ ìƒì„±
                    new_page = new_doc.new_page(width=page.rect.width, height=page.rect.height)
                    
                    # í…ìŠ¤íŠ¸ ì¬êµ¬ì„±
                    for block in text_dict.get("blocks", []):
                        if "lines" in block:
                            for line in block["lines"]:
                                for span in line.get("spans", []):
                                    text = span.get("text", "")
                                    if text.strip():
                                        bbox = span.get("bbox", [0, 0, 100, 20])
                                        new_page.insert_text(
                                            (bbox[0], bbox[1]), 
                                            text, 
                                            fontsize=span.get("size", 12)
                                        )
                
                new_doc.save(output_path)
                new_doc.close()
                doc.close()
                
                print("PDF íŒŒì¼ ë³€í™˜ ì™„ë£Œ (ì§ì ‘ ë°©ì‹)")
                return True
                
            except Exception as direct_error:
                print(f"PDF ì§ì ‘ ì²˜ë¦¬ ì˜¤ë¥˜: {direct_error}")
                return False
        
    except Exception as e:
        print(f"PDF ì²˜ë¦¬ ì˜¤ë¥˜: {e}")
        return False

def word_drm_bypass(source_path, output_path):
    """Word DRM ìš°íšŒ - Wordë¡œ ì½ê³  python-docxë¡œ ì €ì¥"""
    print("Word ë¬¸ì„œ ì²˜ë¦¬ ì¤‘...")
    
    try:
        # python-docx ì„¤ì¹˜ í™•ì¸
        try:
            from docx import Document
        except ImportError:
            print("python-docxë¥¼ ì„¤ì¹˜í•´ì£¼ì„¸ìš”: pip install python-docx")
            return False
        
        pythoncom.CoInitialize()
        word = win32com.client.DispatchEx("Word.Application")
        word.Visible = False
        
        doc = word.Documents.Open(source_path)
        
        # ë¬¸ì„œ ë‚´ìš© ì¶”ì¶œ
        full_text = doc.Content.Text
        
        # í‘œ ë°ì´í„° ì¶”ì¶œ
        tables_data = []
        for table in doc.Tables:
            table_data = []
            for row in table.Rows:
                row_data = []
                for cell in row.Cells:
                    row_data.append(cell.Range.Text.strip())
                table_data.append(row_data)
            tables_data.append(table_data)
        
        doc.Close()
        word.Quit()
        pythoncom.CoUninitialize()
        
        # python-docxë¡œ ìƒˆ ë¬¸ì„œ ìƒì„± (DRM ìš°íšŒ)
        new_doc = Document()
        
        # í…ìŠ¤íŠ¸ ì¶”ê°€
        paragraphs = full_text.split('\n')
        for para in paragraphs:
            if para.strip():
                new_doc.add_paragraph(para.strip())
        
        # í‘œ ì¶”ê°€
        for table_data in tables_data:
            if table_data:
                table = new_doc.add_table(rows=len(table_data), cols=len(table_data[0]))
                for row_idx, row_data in enumerate(table_data):
                    for col_idx, cell_text in enumerate(row_data):
                        table.cell(row_idx, col_idx).text = cell_text
        
        new_doc.save(output_path)
        print("Word ë¬¸ì„œ ë³€í™˜ ì™„ë£Œ")
        return True
        
    except Exception as e:
        print(f"Word ì²˜ë¦¬ ì˜¤ë¥˜: {e}")
        try:
            word.Quit()
            pythoncom.CoUninitialize()
        except:
            pass
        return False

def ppt_drm_bypass(source_path, output_path):
    """PowerPoint DRM ìš°íšŒ - PowerPointë¡œ ì½ê³  python-pptxë¡œ ì €ì¥"""
    print("PowerPoint í”„ë ˆì  í…Œì´ì…˜ ì²˜ë¦¬ ì¤‘...")
    
    try:
        # python-pptx ì„¤ì¹˜ í™•ì¸
        try:
            from pptx import Presentation
        except ImportError:
            print("python-pptxë¥¼ ì„¤ì¹˜í•´ì£¼ì„¸ìš”: pip install python-pptx")
            return False
        
        pythoncom.CoInitialize()
        ppt = win32com.client.DispatchEx("PowerPoint.Application")
        
        presentation = ppt.Presentations.Open(source_path)
        
        # ìŠ¬ë¼ì´ë“œ ë°ì´í„° ì¶”ì¶œ
        slides_data = []
        for slide in presentation.Slides:
            slide_content = {
                'title': '',
                'content': [],
                'notes': ''
            }
            
            for shape in slide.Shapes:
                if shape.HasTextFrame:
                    text = shape.TextFrame.TextRange.Text.strip()
                    if text:
                        if shape.Type == 14:  # Title placeholder
                            slide_content['title'] = text
                        else:
                            slide_content['content'].append(text)
            
            # ìŠ¬ë¼ì´ë“œ ë…¸íŠ¸
            if slide.NotesPage.Shapes.Count > 1:
                notes_text = slide.NotesPage.Shapes(2).TextFrame.TextRange.Text.strip()
                slide_content['notes'] = notes_text
            
            slides_data.append(slide_content)
        
        presentation.Close()
        ppt.Quit()
        pythoncom.CoUninitialize()
        
        # python-pptxë¡œ ìƒˆ í”„ë ˆì  í…Œì´ì…˜ ìƒì„± (DRM ìš°íšŒ)
        new_prs = Presentation()
        
        for i, slide_data in enumerate(slides_data):
            if i == 0:
                slide_layout = new_prs.slide_layouts[0]  # ì œëª© ìŠ¬ë¼ì´ë“œ
            else:
                slide_layout = new_prs.slide_layouts[1]  # ë‚´ìš© ìŠ¬ë¼ì´ë“œ
            
            slide = new_prs.slides.add_slide(slide_layout)
            
            # ì œëª© ì„¤ì •
            if slide_data['title'] and hasattr(slide.shapes, 'title'):
                slide.shapes.title.text = slide_data['title']
            
            # ë‚´ìš© ì¶”ê°€
            if slide_data['content']:
                if len(slide.shapes.placeholders) > 1:
                    content_placeholder = slide.shapes.placeholders[1]
                    if content_placeholder.has_text_frame:
                        content_placeholder.text = '\n'.join(slide_data['content'])
        
        new_prs.save(output_path)
        print("PowerPoint í”„ë ˆì  í…Œì´ì…˜ ë³€í™˜ ì™„ë£Œ")
        return True
        
    except Exception as e:
        print(f"PowerPoint ì²˜ë¦¬ ì˜¤ë¥˜: {e}")
        try:
            ppt.Quit()
            pythoncom.CoUninitialize()
        except:
            pass
        return False

def universal_drm_bypass(source_path, output_path):
    """íŒŒì¼ í™•ì¥ìì— ë”°ë¼ ì ì ˆí•œ DRM ìš°íšŒ ë°©ë²• ì„ íƒ"""
    
    if not os.path.exists(source_path):
        print(f"ì˜¤ë¥˜: ì†ŒìŠ¤ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. {source_path}")
        return False
    
    file_ext = Path(source_path).suffix.lower()
    
    print(f"íŒŒì¼ í˜•ì‹: {file_ext}")
    print(f"ì†ŒìŠ¤: {source_path}")
    print(f"ì¶œë ¥: {output_path}")
    print("-" * 50)
    
    if file_ext in ['.xlsx', '.xls']:
        return excel_drm_bypass(source_path, output_path)
    elif file_ext == '.pdf':
        return pdf_drm_bypass(source_path, output_path)
    elif file_ext in ['.docx', '.doc']:
        return word_drm_bypass(source_path, output_path)
    elif file_ext in ['.pptx', '.ppt']:
        return ppt_drm_bypass(source_path, output_path)
    else:
        print(f"ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹: {file_ext}")
        print("ì§€ì› í˜•ì‹: .xlsx, .xls, .pdf, .docx, .doc, .pptx, .ppt")
        return False

def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    source_path = os.path.join(working_directory, source_file)
    
    file_path = Path(source_file)
    output_filename = f"{output_prefix}{file_path.name}"
    output_path = os.path.join(working_directory, output_filename)
    
    print("=" * 60)
    print("ë²”ìš© DRM ìš°íšŒ íˆ´")
    print("=" * 60)
    
    start_time = time.time()
    
    if universal_drm_bypass(source_path, output_path):
        elapsed_time = time.time() - start_time
        print("-" * 50)
        print(f"âœ… DRM í•´ì œ ì™„ë£Œ! (ì†Œìš”ì‹œê°„: {elapsed_time:.2f}ì´ˆ)")
        print(f"ğŸ“ ì €ì¥ ìœ„ì¹˜: {output_path}")
        print("ğŸ’¡ DRM ì•”í˜¸í™”ê°€ ì œê±°ëœ íŒŒì¼ì…ë‹ˆë‹¤.")
    else:
        print("-" * 50)
        print("âŒ DRM í•´ì œ ì‹¤íŒ¨")

if __name__ == "__main__":
    main()
