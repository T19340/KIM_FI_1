# =============================================================================
# ìˆ˜ë™ ì„¤ì • ë¶€ë¶„
# =============================================================================
working_directory = r"D:\ì±„ê¶Œ\ì‘ì—…ì¤‘"
source_file = "real_data1.xlsx"
output_prefix = "decrypted_"

# =============================================================================
# ìë™ ì‹¤í–‰ ë¶€ë¶„ (ìˆ˜ì • ë¶ˆí•„ìš”)
# =============================================================================
import os
import win32com.client
from pathlib import Path
from datetime import datetime
import time
import pythoncom
import psutil
from openpyxl import Workbook

def clean_cell_value(value):
    """ì…€ ê°’ì—ì„œ íƒ€ì„ì¡´ ì •ë³´ ì œê±°"""
    if isinstance(value, datetime):
        return value.replace(tzinfo=None)
    return value

def kill_excel_processes():
    """ëª¨ë“  Excel í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ"""
    print("Excel í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ ì¤‘...")
    
    killed_count = 0
    for proc in psutil.process_iter(['pid', 'name']):
        try:
            if proc.info['name'].upper() in ['EXCEL.EXE', 'WINWORD.EXE', 'POWERPNT.EXE']:
                proc.kill()
                killed_count += 1
                print(f"  {proc.info['name']} (PID: {proc.info['pid']}) ì¢…ë£Œë¨")
        except (psutil.NoSuchProcess, psutil.AccessDenied):
            pass
    
    if killed_count > 0:
        print(f"ì´ {killed_count}ê°œ Office í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ")
        time.sleep(3)
    else:
        print("ì‹¤í–‰ ì¤‘ì¸ Office í”„ë¡œì„¸ìŠ¤ ì—†ìŒ")

def excel_drm_bypass_preserve_values(source_path, output_path):
    """ê²°ê³¼ê°’ ë³´ì¡´ Excel DRM ìš°íšŒ (í•¨ìˆ˜ëŠ” ì œê±°, ê°’ì€ ë³´ì¡´)"""
    print("ê²°ê³¼ê°’ ë³´ì¡´ Excel ì²˜ë¦¬ ì‹œì‘...")
    
    # 1ë‹¨ê³„: Excel í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
    kill_excel_processes()
    
    # 2ë‹¨ê³„: íŒŒì¼ ì ‘ê·¼ ê¶Œí•œ í™•ì¸
    try:
        with open(source_path, 'rb') as test_file:
            test_file.read(100)
        print("íŒŒì¼ ì ‘ê·¼ ê¶Œí•œ í™•ì¸ë¨")
    except Exception as access_error:
        print(f"íŒŒì¼ ì ‘ê·¼ ì˜¤ë¥˜: {access_error}")
        return False
    
    excel = None
    workbook = None
    
    try:
        # 3ë‹¨ê³„: COM ì´ˆê¸°í™” ë° Excel ì‹¤í–‰
        print("Excel COM ì´ˆê¸°í™”...")
        pythoncom.CoInitializeEx(pythoncom.COINIT_APARTMENTTHREADED)
        
        excel = win32com.client.DispatchEx("Excel.Application")
        excel.Visible = False
        excel.DisplayAlerts = False
        excel.ScreenUpdating = False
        excel.EnableEvents = False
        
        # ì™¸ë¶€ ë°ì´í„° ì—°ê²° ì•Œë¦¼ ë¹„í™œì„±í™” (í•˜ì§€ë§Œ ê¸°ì¡´ ê°’ì€ ìœ ì§€)
        excel.AskToUpdateLinks = False
        excel.AlertBeforeOverwriting = False
        
        print("Excel ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒì„± ì„±ê³µ")
        
        # 4ë‹¨ê³„: íŒŒì¼ ì—´ê¸° (ì™¸ë¶€ ì—°ê²° ì—…ë°ì´íŠ¸ ì•ˆí•¨, ê¸°ì¡´ ê°’ ìœ ì§€)
        print("íŒŒì¼ ì—´ê¸° ì¤‘ (ì™¸ë¶€ ì—°ê²° ì—…ë°ì´íŠ¸ ì•ˆí•¨)...")
        try:
            workbook = excel.Workbooks.Open(
                source_path,
                UpdateLinks=0,          # ì™¸ë¶€ ë§í¬ ì—…ë°ì´íŠ¸ ì•ˆí•¨ (ê¸°ì¡´ ê°’ ìœ ì§€)
                ReadOnly=True,          # ì½ê¸° ì „ìš©
                IgnoreReadOnlyRecommended=True
            )
            print("íŒŒì¼ ì—´ê¸° ì„±ê³µ (ê¸°ì¡´ ê³„ì‚°ê°’ ìœ ì§€)")
        except Exception as open_error:
            print(f"íŒŒì¼ ì—´ê¸° ì‹¤íŒ¨: {open_error}")
            raise
        
        # 5ë‹¨ê³„: ê³„ì‚° ëª¨ë“œë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì„¤ì • (ì¶”ê°€ ê³„ì‚° ë°©ì§€, ê¸°ì¡´ ê°’ ìœ ì§€)
        print("ê³„ì‚° ëª¨ë“œ ìˆ˜ë™ ì„¤ì • (ê¸°ì¡´ ê°’ ë³´ì¡´)...")
        try:
            excel.Calculation = -4135  # xlCalculationManual (ìƒˆ ê³„ì‚° ë°©ì§€)
            excel.CalculateBeforeSave = False
            print("ìˆ˜ë™ ê³„ì‚° ëª¨ë“œ ì„¤ì • ì™„ë£Œ - ê¸°ì¡´ ê³„ì‚°ê°’ ë³´ì¡´ë¨")
        except Exception as calc_error:
            print(f"ê³„ì‚° ëª¨ë“œ ì„¤ì • ì˜¤ë¥˜: {calc_error}")
        
        # 6ë‹¨ê³„: ì›Œí¬ì‹œíŠ¸ ì ‘ê·¼
        print("ì›Œí¬ì‹œíŠ¸ ì •ë³´ í™•ì¸ ì¤‘...")
        try:
            worksheet_count = workbook.Worksheets.Count
            print(f"ì›Œí¬ì‹œíŠ¸ ê°œìˆ˜: {worksheet_count}")
            
            worksheet = workbook.Worksheets(1)
            print(f"ì›Œí¬ì‹œíŠ¸ ì„ íƒ ì„±ê³µ: {worksheet.Name}")
        except Exception as ws_error:
            print(f"ì›Œí¬ì‹œíŠ¸ ì„ íƒ ì˜¤ë¥˜: {ws_error}")
            raise
        
        # 7ë‹¨ê³„: ì‚¬ìš©ëœ ë²”ìœ„ í™•ì¸ (ë” ê´€ëŒ€í•˜ê²Œ)
        print("ì‚¬ìš©ëœ ë²”ìœ„ í™•ì¸ ì¤‘...")
        try:
            used_range = worksheet.UsedRange
            if used_range:
                rows = used_range.Rows.Count
                cols = used_range.Columns.Count
                print(f"ì‚¬ìš©ëœ ë²”ìœ„: {rows}í–‰ {cols}ì—´")
            else:
                print("UsedRangeê°€ None, ëŒ€ì²´ ë°©ë²• ì‚¬ìš©")
                # ëŒ€ì²´ ë°©ë²•: ë°ì´í„°ê°€ ìˆëŠ” ë§ˆì§€ë§‰ ì…€ ì°¾ê¸°
                last_cell = worksheet.Cells.SpecialCells(11)  # xlCellTypeLastCell
                rows = last_cell.Row
                cols = last_cell.Column
                print(f"ë§ˆì§€ë§‰ ì…€ ê¸°ì¤€ ë²”ìœ„: {rows}í–‰ {cols}ì—´")
        except Exception as range_error:
            print(f"ë²”ìœ„ í™•ì¸ ì˜¤ë¥˜: {range_error}")
            # ê¸°ë³¸ê°’ ì‚¬ìš©
            rows = 1000
            cols = 50
            print(f"ê¸°ë³¸ ë²”ìœ„ ì‚¬ìš©: {rows}í–‰ {cols}ì—´")
        
        # 8ë‹¨ê³„: ê°’ ì „ì²´ ì¶”ì¶œ (Value ì†ì„±ìœ¼ë¡œ í•œ ë²ˆì—)
        print("ëª¨ë“  ê³„ì‚°ê°’ í•œ ë²ˆì— ì¶”ì¶œ ì‹œë„...")
        cleaned_data = []
        
        try:
            # ì „ì²´ ë²”ìœ„ì—ì„œ Value ì†ì„±ìœ¼ë¡œ í•œ ë²ˆì— ì¶”ì¶œ
            if 'used_range' in locals() and used_range:
                data_range = used_range.Value
            else:
                # UsedRangeê°€ ì—†ìœ¼ë©´ ìˆ˜ë™ìœ¼ë¡œ ë²”ìœ„ ì„¤ì •
                range_address = f"A1:{chr(64 + min(cols, 26))}{min(rows, 10000)}"
                manual_range = worksheet.Range(range_address)
                data_range = manual_range.Value
            
            print(f"ë°ì´í„° ì¶”ì¶œ ì„±ê³µ, íƒ€ì…: {type(data_range)}")
            
            if data_range is not None:
                if isinstance(data_range, tuple):
                    # ë‹¤ì¤‘ í–‰ ë°ì´í„°
                    for row_data in data_range:
                        if isinstance(row_data, tuple):
                            cleaned_row = [clean_cell_value(cell) for cell in row_data]
                        else:
                            cleaned_row = [clean_cell_value(row_data)]
                        cleaned_data.append(cleaned_row)
                else:
                    # ë‹¨ì¼ ì…€ ë°ì´í„°
                    cleaned_data = [[clean_cell_value(data_range)]]
                
                print(f"ê°’ ì¶”ì¶œ ì™„ë£Œ: {len(cleaned_data)}í–‰ (ëª¨ë“  ê³„ì‚°ê°’ ë³´ì¡´)")
            else:
                raise Exception("ë°ì´í„° ì¶”ì¶œ ê²°ê³¼ê°€ None")
                
        except Exception as value_error:
            print(f"ì „ì²´ ì¶”ì¶œ ì‹¤íŒ¨: {value_error}")
            print("ê°œë³„ ì…€ ì¶”ì¶œ ì‹œë„...")
            
            # ê°œë³„ ì…€ ì¶”ì¶œ (í´ë°±)
            cleaned_data = []
            for row in range(1, min(rows + 1, 5000)):
                row_data = []
                for col in range(1, min(cols + 1, 100)):
                    try:
                        cell = worksheet.Cells(row, col)
                        # ì…€ì˜ í˜„ì¬ í‘œì‹œê°’ ê°€ì ¸ì˜¤ê¸° (í•¨ìˆ˜ ê²°ê³¼ê°’ í¬í•¨)
                        value = cell.Value
                        row_data.append(clean_cell_value(value))
                    except Exception as cell_error:
                        # ì ‘ê·¼ ë¶ˆê°€ëŠ¥í•œ ì…€ì€ ë¹ˆ ê°’
                        row_data.append("")
                
                cleaned_data.append(row_data)
                
                # ì§„í–‰ ìƒí™© í‘œì‹œ
                if row % 100 == 0:
                    print(f"    {row}í–‰ ì²˜ë¦¬ ì™„ë£Œ...")
            
            print(f"ê°œë³„ ì¶”ì¶œ ì™„ë£Œ: {len(cleaned_data)}í–‰")
        
        # 9ë‹¨ê³„: Excel ì¢…ë£Œ
        print("Excel ì¢…ë£Œ ì¤‘...")
        try:
            workbook.Close(SaveChanges=False)
            workbook = None
            excel.Quit()
            excel = None
            pythoncom.CoUninitialize()
            print("Excel ì •ìƒ ì¢…ë£Œ")
        except Exception as close_error:
            print(f"Excel ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜: {close_error}")
        
        # 10ë‹¨ê³„: ìƒˆ íŒŒì¼ ìƒì„± (ê°’ë§Œ ì €ì¥, í•¨ìˆ˜ëŠ” ì œê±°ë¨)
        print("ìƒˆ Excel íŒŒì¼ ìƒì„± ì¤‘ (ê°’ë§Œ ì €ì¥)...")
        wb = Workbook()
        ws = wb.active
        
        actual_data_rows = 0
        for row_idx, row_data in enumerate(cleaned_data, 1):
            has_data = False
            for col_idx, cell_value in enumerate(row_data, 1):
                try:
                    if cell_value is not None and str(cell_value).strip():
                        has_data = True
                    ws.cell(row=row_idx, column=col_idx, value=cell_value)
                except Exception:
                    ws.cell(row=row_idx, column=col_idx, value="")
            
            if has_data:
                actual_data_rows = row_idx
        
        wb.save(output_path)
        wb.close()
        
        print(f"Excel DRM ìš°íšŒ ì™„ë£Œ - {actual_data_rows}í–‰ì˜ ê³„ì‚°ê°’ ë³´ì¡´ë¨")
        print("ğŸ’¡ ëª¨ë“  í•¨ìˆ˜ëŠ” ê³„ì‚°ëœ ê²°ê³¼ê°’ìœ¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤")
        return True
        
    except Exception as main_error:
        print(f"ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {main_error}")
        return False
        
    finally:
        # ë¦¬ì†ŒìŠ¤ ì •ë¦¬
        try:
            if workbook:
                workbook.Close(SaveChanges=False)
        except:
            pass
        
        try:
            if excel:
                excel.Quit()
        except:
            pass
        
        try:
            pythoncom.CoUninitialize()
        except:
            pass

def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    source_path = os.path.join(working_directory, source_file)
    
    file_path = Path(source_file)
    output_filename = f"{output_prefix}{file_path.name}"
    output_path = os.path.join(working_directory, output_filename)
    
    print("=" * 60)
    print("ê²°ê³¼ê°’ ë³´ì¡´ Excel DRM ìš°íšŒ íˆ´")
    print("=" * 60)
    print("í•µì‹¬ ì›ë¦¬: í•¨ìˆ˜ ì œê±° + ê³„ì‚°ëœ ê²°ê³¼ê°’ ë³´ì¡´")
    print("=" * 60)
    
    if not os.path.exists(source_path):
        print(f"ì˜¤ë¥˜: íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: {source_path}")
        return
    
    file_size = os.path.getsize(source_path)
    print(f"ì›ë³¸ íŒŒì¼ í¬ê¸°: {file_size:,} bytes")
    
    start_time = time.time()
    
    if excel_drm_bypass_preserve_values(source_path, output_path):
        elapsed_time = time.time() - start_time
        print("-" * 50)
        print(f"âœ… Excel DRM ìš°íšŒ ì™„ë£Œ! (ì†Œìš”ì‹œê°„: {elapsed_time:.2f}ì´ˆ)")
        print(f"ğŸ“ ì €ì¥ ìœ„ì¹˜: {output_path}")
        
        if os.path.exists(output_path):
            output_size = os.path.getsize(output_path)
            print(f"ğŸ“Š ìƒì„±ëœ íŒŒì¼ í¬ê¸°: {output_size:,} bytes")
            print("ğŸ“‹ íŠ¹ì§•: ì¸í¬ë§¥ìŠ¤ ë“± í•¨ìˆ˜ëŠ” ì œê±°ë˜ì—ˆì§€ë§Œ ê³„ì‚°ëœ ê°’ì€ ëª¨ë‘ ë³´ì¡´ë¨")
    else:
        elapsed_time = time.time() - start_time
        print("-" * 50)
        print(f"âŒ Excel DRM ìš°íšŒ ì‹¤íŒ¨ (ì†Œìš”ì‹œê°„: {elapsed_time:.2f}ì´ˆ)")

if __name__ == "__main__":
    main()
